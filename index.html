<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Inventory Pro</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            /* Base Theme (Dark Blue/Slate) */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --border: #334155;
        }

        /* Light Theme Variables */
        [data-theme="light"] {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background 0.3s ease;
        }

        /* ================= LOGIN SCREEN (iPhone Style) ================= */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }

        .login-card {
            /* Removed card background for cleaner iPhone look, or keep transparent */
            padding: 20px;
            text-align: center;
            width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .login-icon { 
            font-size: 2.5rem; color: white; margin-bottom: 20px;
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .login-title { font-size: 1.5rem; font-weight: 600; color: white; margin: 0 0 10px 0; }
        .login-subtitle { color: #cbd5e1; font-size: 0.9rem; margin-bottom: 30px; }

        .pin-dots { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .dot { 
            width: 12px; height: 12px; border-radius: 50%; 
            border: 1px solid #fff; transition: 0.2s; 
            background: transparent;
        }
        .dot.filled { background: white; box-shadow: 0 0 10px white; }
        .dot.error { border-color: #ef4444; background: #ef4444; }

        /* iPhone Style Grid */
        .keypad { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 25px; 
            width: 100%; 
            justify-items: center;
        }
        
        .key {
            width: 75px; height: 75px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.8rem;
            font-weight: 400;
            cursor: pointer;
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .key:hover { background: rgba(255, 255, 255, 0.3); }
        .key:active { background: rgba(255, 255, 255, 0.5); }
        .key i { font-size: 1.2rem; }

        /* ================= MAIN APP ================= */
        #app-container { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Header Layout: Right side stacked */
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        
        .header-left h1 { margin: 0; font-size: 2rem; letter-spacing: -0.5px; }
        .sync-badge { 
            font-size: 0.8rem; background: rgba(16, 185, 129, 0.1); color: var(--accent-green);
            padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.2);
            display: inline-flex; align-items: center; gap: 6px; margin-top: 8px;
        }
        .dot-status { width: 8px; height: 8px; background: currentColor; border-radius: 50%; }

        /* Right Column Stack */
        .header-right { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 5px; 
        }

        .header-actions { display: flex; gap: 10px; margin-bottom: 5px; }
        
        .clock { 
            font-size: 2.8rem; 
            font-weight: 300; 
            line-height: 1; 
            font-variant-numeric: tabular-nums;
            margin-top: 5px;
        }

        .icon-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
            font-size: 1rem;
        }
        .icon-btn:hover { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); color: white; }

        /* Controls Bar */
        .controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            gap: 15px; 
            flex-wrap: wrap; 
        }
        
        .search-box { flex: 1; position: relative; min-width: 250px; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .search-input { 
            width: 100%; padding: 12px 12px 12px 40px; background: var(--bg-card); 
            border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; box-sizing: border-box;
            outline: none;
        }
        .search-input:focus { border-color: var(--accent-blue); }

        .action-group { display: flex; gap: 10px; }

        .btn-green { 
            background: var(--accent-green); color: #0f172a; border: none; padding: 0 20px; height: 42px;
            font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: opacity 0.2s;
        }
        .btn-green:hover { opacity: 0.9; }

        /* Special Scan Button Style */
        .btn-scan {
            background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border);
            width: 42px; height: 42px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .btn-scan:hover { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }

        /* --- TABLE VIEW (Desktop) --- */
        .table-wrapper { 
            background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th { 
            background: var(--bg-body); padding: 15px; font-size: 0.8rem; text-transform: uppercase; 
            letter-spacing: 1px; color: var(--text-muted); border-bottom: 1px solid var(--border);
        }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .badge { background: rgba(59, 130, 246, 0.1); color: #60a5fa; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .price { color: var(--accent-green); font-family: monospace; font-weight: 600; }
        .action-cell { display: flex; gap: 8px; }
        .btn-mini { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 5px; }
        .btn-mini:hover { color: var(--text-main); transform: scale(1.1); }
        .btn-mini.del:hover { color: var(--accent-red); }

        /* --- CARD VIEW (Mobile) --- */
        .mobile-list { display: none; flex-direction: column; gap: 10px; }
        .mobile-card {
            background: var(--bg-card); padding: 15px; border-radius: 8px; 
            border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .m-info h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .m-meta { font-size: 0.8rem; color: var(--text-muted); }

        /* Responsive Switch */
        @media (max-width: 768px) {
            .table-wrapper { display: none; }
            .mobile-list { display: flex; }
            .header-actions { margin-bottom: 0; }
            .clock { font-size: 2rem; }
            .controls { flex-direction: column-reverse; align-items: stretch; }
            .action-group { justify-content: space-between; }
            .btn-green, .btn-scan { width: 100%; justify-content: center; }
            .btn-scan { width: 50px; } /* Keep scan small on mobile row */
        }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { 
            background: var(--bg-card); padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; 
            border: 1px solid var(--border); position: relative; max-height: 90vh; overflow-y: auto;
        }
        .close-btn { position: absolute; right: 20px; top: 20px; background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; box-sizing: border-box; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        /* Settings List */
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .settings-item:last-child { border: none; }
    </style>
</head>
<body data-theme="dark">

    <div id="login-screen">
        <div class="login-card">
            <div class="login-icon">
                <i class="fas fa-fingerprint"></i>
            </div>
            
            <h2 class="login-title">Home Inventory</h2>
            <p class="login-subtitle" id="pin-msg">Enter PIN to access</p>
            
            <div class="pin-dots" id="pin-dots">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>

            <div class="keypad">
                <button class="key" onclick="enterDigit(1)">1</button>
                <button class="key" onclick="enterDigit(2)">2</button>
                <button class="key" onclick="enterDigit(3)">3</button>
                <button class="key" onclick="enterDigit(4)">4</button>
                <button class="key" onclick="enterDigit(5)">5</button>
                <button class="key" onclick="enterDigit(6)">6</button>
                <button class="key" onclick="enterDigit(7)">7</button>
                <button class="key" onclick="enterDigit(8)">8</button>
                <button class="key" onclick="enterDigit(9)">9</button>
                <button class="key" style="opacity:0; pointer-events:none;"></button>
                <button class="key" onclick="enterDigit(0)">0</button>
                <button class="key" onclick="deleteDigit()"><i class="fas fa-backspace"></i></button>
            </div>
        </div>
    </div>

    <div id="app-container">
        
        <div class="header">
            <div class="header-left">
                <h1>Inventory</h1>
                <div class="sync-badge" id="syncStatus"><div class="dot-status"></div> <span id="syncText">Synced</span></div>
            </div>
            
            <div class="header-right">
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-adjust" id="theme-icon"></i></button>
                    <button class="icon-btn" onclick="openModal('settingsModal')" title="Settings"><i class="fas fa-cog"></i></button>
                    <button class="icon-btn logout-btn" onclick="logout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <div class="clock" id="clock">00:00</div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search items, categories..." onkeyup="handleSearch()">
            </div>
            
            <div class="action-group">
                <button class="btn-scan" onclick="openAddModal(true)" title="Scan QR">
                    <i class="fas fa-qrcode"></i>
                </button>
                
                <button class="btn-green" style="background:var(--accent-blue); color:white" onclick="openAddModal(false)">
                    <i class="fas fa-plus"></i> Add Item
                </button>
                
                <button class="btn-green" onclick="exportExcel()">
                    <i class="fas fa-file-csv"></i> Export
                </button>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Price</th>
                        <th>Qty</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
            <div style="padding:15px; display:flex; justify-content:center; gap:10px; border-top:1px solid var(--border);">
                <button class="btn-mini" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                <span id="pageInfo" style="font-size:0.9rem; align-self:center; color:var(--text-muted);">Page 1</span>
                <button class="btn-mini" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="mobile-list" id="mobile-list"></div>

    </div>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('itemModal')">&times;</button>
            <h2 id="modalTitle">Add Item</h2>
            <div id="reader" style="width:100%; display:none; border-radius:8px; overflow:hidden; margin-bottom:15px;"></div>
            
            <input type="hidden" id="editId">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="itemName" class="form-input" placeholder="e.g. MacBook Pro">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="itemCat" class="form-input" placeholder="Electronics">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="itemLoc" class="form-input" placeholder="Office">
                </div>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Price (₹)</label>
                    <input type="number" id="itemPrice" class="form-input" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="itemQty" class="form-input" value="1">
                </div>
            </div>
            <div class="form-group">
                <label>Barcode / QR</label>
                <input type="text" id="itemCode" class="form-input" placeholder="Scan or Enter Code">
            </div>
            <button class="btn-full" style="background:var(--accent-blue); color:white;" onclick="saveItem()">Save Item</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            <h2>Settings</h2>

            <div class="form-group" style="margin-top:15px;">
                <label>Google Script URL (Drive Sync)</label>
                <input type="text" id="gasUrl" class="form-input" placeholder="https://script.google.com/..." onchange="saveConfig()">
                <button class="btn-full" style="background:var(--accent-green); color:#000; margin-top:5px;" onclick="saveToDrive()">Sync Now</button>
            </div>

            <div class="grid-2" style="margin-top:15px;">
                <button class="btn-full" style="background:var(--bg-body); border:1px solid var(--border); color:var(--text-main);" onclick="exportJSON()">
                    <i class="fas fa-download"></i> Backup JSON
                </button>
                <button class="btn-full" style="background:var(--bg-body); border:1px solid var(--border); color:var(--text-main);" onclick="document.getElementById('importFile').click()">
                    <i class="fas fa-upload"></i> Restore JSON
                </button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importJSON(this)">
            </div>

            <button class="btn-full" style="background:var(--accent-red); color:white; margin-top:20px;" onclick="resetPin()">Reset App PIN</button>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <button class="close-btn" onclick="closeModal('viewModal')">&times;</button>
            <h2 id="viewName">Item Name</h2>
            <div id="qr-display" style="background:white; padding:10px; border-radius:8px; display:inline-block; margin:15px 0;"></div>
            <div id="viewDetails" style="text-align:left; color:var(--text-muted); line-height:1.6;"></div>
        </div>
    </div>

    <script>
        // --- 1. PIN LOGIC ---
        let currentPin = [];
        let savedPin = localStorage.getItem('appPin');
        const dots = document.querySelectorAll('.dot');
        const pinMsg = document.getElementById('pin-msg');

        function initPin() {
            if (!savedPin) {
                pinMsg.innerText = "Create a 4-digit PIN";
            } else {
                pinMsg.innerText = "Enter PIN to access";
            }
        }

        function enterDigit(digit) {
            if (currentPin.length < 4) {
                currentPin.push(digit);
                updateDots();
            }
            if (currentPin.length === 4) {
                setTimeout(checkPin, 200);
            }
        }

        function deleteDigit() {
            currentPin.pop();
            updateDots();
        }

        function updateDots() {
            dots.forEach((dot, idx) => {
                if (idx < currentPin.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            });
        }

        function checkPin() {
            const entered = currentPin.join('');
            
            if (!savedPin) {
                // Setup Mode
                localStorage.setItem('appPin', entered);
                savedPin = entered;
                alert("PIN Created!");
                unlockApp();
            } else {
                // Login Mode
                if (entered === savedPin) {
                    unlockApp();
                } else {
                    dots.forEach(d => d.classList.add('error'));
                    setTimeout(() => {
                        dots.forEach(d => { d.classList.remove('error'); d.classList.remove('filled'); });
                        currentPin = [];
                    }, 500);
                }
            }
        }

        function unlockApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            initApp();
        }

        // --- LOGOUT LOGIC ---
        function logout() {
            currentPin = [];
            updateDots();
            dots.forEach(d => { d.classList.remove('error'); d.classList.remove('filled'); });
            
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }

        function resetPin() {
            if(confirm("This will remove the PIN protection. Continue?")) {
                localStorage.removeItem('appPin');
                location.reload();
            }
        }

        // --- 2. APP LOGIC ---
        let inventory = JSON.parse(localStorage.getItem('myInventory')) || [];
        let html5QrcodeScanner = null;
        let currentPage = 1;
        const itemsPerPage = 8;
        let filteredData = [];

        function initApp() {
            // Load Settings
            document.getElementById('gasUrl').value = localStorage.getItem('gasUrl') || '';
            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
            
            // Start Clock
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
            }, 1000);

            // Render
            handleSearch();
        }

        // --- RENDER ---
        function render(data) {
            const tBody = document.getElementById('table-body');
            const mList = document.getElementById('mobile-list');
            tBody.innerHTML = '';
            mList.innerHTML = '';

            const totalPages = Math.ceil(data.length / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const pageData = data.slice(start, start + itemsPerPage);

            // Desktop Rows
            pageData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${item.name}</strong></td>
                    <td><span class="badge">${item.category || '-'}</span></td>
                    <td>${item.location || '-'}</td>
                    <td class="price">₹${item.price || 0}</td>
                    <td>${item.qty}</td>
                    <td style="font-size:0.8rem; color:var(--text-muted)">${new Date(item.date).toLocaleDateString()}</td>
                    <td class="action-cell">
                        <button class="btn-mini" onclick="viewItem(${item.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn-mini" onclick="editItem(${item.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn-mini del" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tBody.appendChild(tr);

                // Mobile Cards
                const card = document.createElement('div');
                card.className = 'mobile-card';
                card.innerHTML = `
                    <div class="m-info">
                        <h3>${item.name}</h3>
                        <div class="m-meta">${item.location} • Qty: ${item.qty}</div>
                        <div class="price">₹${item.price || 0}</div>
                    </div>
                    <div class="action-cell">
                        <button class="btn-mini" onclick="viewItem(${item.id})"><i class="fas fa-eye"></i></button>
                        <button class="btn-mini" onclick="editItem(${item.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn-mini del" onclick="deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                mList.appendChild(card);
            });

            document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages}`;
            if (data.length === 0) {
                tBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No items found</td></tr>';
                mList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No items found</div>';
            }
        }

        // --- CRUD ---
        function saveItem() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('itemName').value;
            let code = document.getElementById('itemCode').value;

            if(!name) return alert("Item Name is required");
            if(!code) code = 'INV-' + Date.now().toString().slice(-6);

            const newItem = {
                id: id ? parseInt(id) : Date.now(),
                name, 
                category: document.getElementById('itemCat').value,
                location: document.getElementById('itemLoc').value,
                price: document.getElementById('itemPrice').value,
                qty: document.getElementById('itemQty').value,
                code,
                date: new Date().toISOString()
            };

            if(id) {
                const idx = inventory.findIndex(i => i.id == id);
                inventory[idx] = newItem;
            } else {
                inventory.unshift(newItem);
            }

            saveLocal();
            closeModal('itemModal');
            if(html5QrcodeScanner) html5QrcodeScanner.clear();
        }

        function deleteItem(id) {
            if(confirm("Delete item?")) {
                inventory = inventory.filter(i => i.id !== id);
                saveLocal();
            }
        }

        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            document.getElementById('editId').value = item.id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCat').value = item.category;
            document.getElementById('itemLoc').value = item.location;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemQty').value = item.qty;
            document.getElementById('itemCode').value = item.code;
            document.getElementById('modalTitle').innerText = "Edit Item";
            openModal('itemModal');
        }

        function viewItem(id) {
            const item = inventory.find(i => i.id === id);
            document.getElementById('viewName').innerText = item.name;
            document.getElementById('viewDetails').innerHTML = `
                ID: ${item.code}<br>
                Category: ${item.category}<br>
                Location: ${item.location}<br>
                Price: ₹${item.price}<br>
                Quantity: ${item.qty}
            `;
            const qrBox = document.getElementById('qr-display');
            qrBox.innerHTML = '';
            new QRCode(qrBox, { text: item.code, width: 128, height: 128 });
            openModal('viewModal');
        }

        // --- UTILS ---
        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            filteredData = inventory.filter(i => 
                i.name.toLowerCase().includes(term) || 
                (i.category && i.category.toLowerCase().includes(term))
            );
            currentPage = 1;
            render(filteredData);
        }

        function changePage(d) {
            currentPage += d;
            render(filteredData);
        }

        function saveLocal() {
            localStorage.setItem('myInventory', JSON.stringify(inventory));
            document.getElementById('syncText').innerText = "Not Synced";
            document.getElementById('syncStatus').style.color = "var(--text-muted)";
            handleSearch();
        }

        function saveConfig() {
            localStorage.setItem('gasUrl', document.getElementById('gasUrl').value);
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if(theme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // --- SYNC & EXPORT ---
        function saveToDrive() {
            const url = document.getElementById('gasUrl').value;
            if(!url) return alert("Set Google Script URL in settings");
            
            fetch(url, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(inventory)
            }).then(() => {
                alert("Synced!");
                document.getElementById('syncText').innerText = "Synced";
                document.getElementById('syncStatus').style.color = "var(--accent-green)";
            });
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(inventory);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventory");
            XLSX.writeFile(wb, "Inventory.xlsx");
        }

        function exportJSON() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventory));
            const a = document.createElement('a');
            a.href = str; a.download = "backup.json";
            a.click();
        }

        function importJSON(input) {
            const reader = new FileReader();
            reader.onload = e => {
                inventory = JSON.parse(e.target.result);
                saveLocal();
                alert("Imported!");
                closeModal('settingsModal');
            };
            reader.readAsText(input.files[0]);
        }

        // --- MODAL & SCANNER ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function openAddModal(scan) {
            document.getElementById('editId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemCode').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemQty').value = '1';
            document.getElementById('modalTitle').innerText = "Add Item";
            openModal('itemModal');
            
            if(scan) {
                document.getElementById('reader').style.display = 'block';
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
                html5QrcodeScanner.render((decoded) => {
                    document.getElementById('itemCode').value = decoded;
                    html5QrcodeScanner.clear();
                    document.getElementById('reader').style.display = 'none';
                });
            } else {
                document.getElementById('reader').style.display = 'none';
            }
        }

        // Start
        initPin();
    </script>
</body>
</html>
